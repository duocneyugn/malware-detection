<?php 
require_once "login.php";
require_once "layout-1.html";
require_once "functions.php";
session_start();

$conn = new mysqli($hn, $un, $pw, $db);
if($conn->connect_error)die($connect_error);



if(isset($_SESSION['users']) && isset($_COOKIE['users']))
{	
	$name = "";
	$name = $_SESSION['forename'];
	$name .= " ".$_SESSION['surname'];
	echo "<script type='text/javascript'>
	document.getElementById('login-required-msg').style.display = 'none';
	document.getElementById('loged-in-msg').style.display = 'block';
	document.getElementById('loged-in-msg').style.background = 'green';
	document.getElementById('loged-in-msg').innerHTML='You are now logged in as $name!';
	</script>";
}
else 
{
	echo "<script type='text/javascript'>
	document.getElementById('login-required-msg').style.display = 'block';
	document.getElementById('loged-in-msg').style.display = 'none';
	</script>";
}

if($_FILES && isset($_SESSION['users']) && isset($_COOKIE['users'])){
	$name = "";
	$name = $_FILES['text_file']['name'];
		//sanatize name
	$name = strtolower(preg_replace("[^A-Za-z0-9.]", "", $name));
		//validate file
	// if($_FILES['text_file']['type'] == 'text/plain'){
	// 		//reads the file and look for integers. 
	move_uploaded_file($_FILES['text_file']['name'], $name);
	scanUploadedFile($name,$conn);
	// } else {
	// 	echo "Uploaded is not a text file. Please upload a text file.";
	// }
}

$conn->close();

	/**
	*	Reads the file line by line. 
	*	Returns a list of integers. 
	*/
	function scanUploadedFile($file, $conn){
		$fh = $content = $seed = $found = $nextBytes = "";

		if($file === ""){
			echo "File name not found.<br>";
			return;
		}
		$fh = fopen($file, 'rb') or die("Failed to open file");
		$content = fread($fh, 20);
		while($content){
			$seed = substr($content, -20);
			$found = scanForMalware($seed, $conn);
			if($found)
			{
				fclose($fh);
				return;
			}
			$nextBytes = $content.fread($fh, 1);
			if($content === $nextBytes)
				break;
			else
				$content = $nextBytes;
		}
		//no virus found
		echo "File clean.<br>";
		fclose($fh);
	}


	function scanForMalware($str, $conn)
	{
		$query = $result = $signature = $hash_str = $hash_signature = "";
		$query = "SELECT * FROM signatures";
		$result = $conn->query($query);
		if(!$result)die($conn->error);
		if($result->num_rows > 0)
		{
			while($row = $result->fetch_array())
			{
				$empty = "";
				$signature = $row['signature'];
				$hash_str = get_hashed_string($str, $empty, $empty);
				$hash_signature = get_hashed_string($signature, $empty, $empty);
				if($hash_str === $hash_signature)
				{
					echo "File Infected with malware: ".$row['name'].".<br>";
					return true;
				}
			}
		}
		return false;
	}

	?>