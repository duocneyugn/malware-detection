<?php 
require_once "login.php";
require_once "functions.php";
require_once "sign-up.html";

$conn = "";

$conn = new mysqli($hn, $un, $pw, $db);
if($conn->connect_error)die($conn->connect_error);

$username = $password = $forename = $surname = "";

if(isset($_POST['username']))
{
	$username = mysql_entities_fix_string($conn, $_POST['username']);
}
if(isset($_POST['password']))
{
	$password = mysql_entities_fix_string($conn, $_POST['password']);
}
if(isset($_POST['forename']))
{
	$forename = mysql_entities_fix_string($conn, $_POST['forename']);
}
if(isset($_POST['surname']))
{
	$surname = mysql_entities_fix_string($conn, $_POST['surname']);
}

$fail  = "";
$fail  = validate_username($username);
$fail .= validate_password($password);
$fail .= validate_forename($forename);
$fail .= validate_surname($surname);


if(isset($_POST['username']) && isset($_POST['password']) && isset($_POST['forename']) && isset($_POST['surname']))
{
	if($fail != "")
	{
		echo $fail;
		exit;
	}
	$un_temp = $pw_temp = $salt1 = $salt2 = "";
	$auth = 'users';
	$un_temp = $username;
	$pw_temp = $password;
	$salt1 = get_random_string(5);
	$salt2 = get_random_string(5);


	$hashed_pw = get_hashed_string($pw_temp, $salt1, $salt2);
	$stmt = $conn->prepare('INSERT INTO `users` (`username`, `password`,`forename`,`surname`,`salt1`,`salt2`) VALUES (?, ?, ?, ?, ?, ?)');
	$stmt->bind_param('ssssss', $un_temp, $hashed_pw, $forename, $surname, $salt1, $salt2);
	$result = $stmt->execute();
	if(!$result)die("Email already used. Please use another email.");
	$stmt->close();
	echo "Hello ".$forename." ".$surname. " you have successfully signed up. Please <a href='sign-in.php'>log in</a> to use our service.";
}


$conn->close();


?>