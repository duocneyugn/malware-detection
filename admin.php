<?php 

require_once "login.php";
require_once "admin.html";
require_once "functions.php";
session_start();
$conn = new mysqli($hn, $un, $pw, $db);
if($conn->connect_error)die($connect_error);


if(isset($_COOKIE['admins']) && isset($_SESSION['admins']))
{
	echo "Welcome ".$_COOKIE['admins']."<br>";
	echo "<script type='text/javascript'>
	document.getElementById('upload-signature').style.display = 'block';
	document.getElementById('logout-btn').style.display = 'block';
    </script>";
}
else
{
	echo "<script type='text/javascript'>
	document.getElementById('upload-signature').style.display = 'none';
	document.getElementById('logout-btn').style.display = 'none';
    </script>";
}

$username = $password = "";
if(isset($_POST['username']))
{
	$username = mysql_entities_fix_string($conn, $_POST['username']);
}
if(isset($_POST['password']))
{
	$password = mysql_entities_fix_string($conn, $_POST['password']);
}
$fail  = "";
$fail  = validate_username($username);
$fail .= validate_password($password); 

if(isset($_POST['username']) && isset($_POST['password']))
{
	$un = $pw = "";
	if($fail != "")
	{
		echo $fail;
		exit;
	}
	$un = $username;
	$pw = $password;
	$auth = 'admins';
	authenticate($auth,$un,$pw,$conn);
	header("location: admin.php");
}

if(isset($_POST['logout']))
{
	$forename = $surname = "";
	$forename = $_SESSION['forename'];
	$surname = $_SESSION['surname'];
	$auth = 'admins';
	setcookie($auth, "", time()-2592000, '/');
	$_SESSION = array();
	session_destroy();
	unset($_POST['logout']);
	echo $forename." ".$surname.", you have successfully logged out!";
	header('location: admin.php');
}

if($_FILES && isset($_SESSION['admins']) && isset($_COOKIE['admins'])){
		$name = $result = "";
		$name = $_FILES['text_file']['name'];
		//sanatize name
		$name = strtolower(preg_replace("[^A-Za-z0-9.]", "", $name));
		//validate file
		if($_FILES['text_file']['type'] == 'text/plain'){
			//reads the file and look for integers. 
			move_uploaded_file($_FILES['text_file']['name'], $name);
			$result = read_uploaded_file($conn, $name);
			if($result)
				echo "Successfully stored signature";
			else
				echo "Unsuccessfully stored signature";
		} else {
			echo "Uploaded is not a text file. Please upload a text file.";
		}
}

$conn->close();

function read_uploaded_file($conn, $file)
{
	$fh = $line = $signature = "";
	if($file === ""){
			echo "File name not found.<br>";
			return false;
		}
		$fh = fopen($file, 'r') or die("Failed to open file");
		$line = fgets($fh); 
		if(!$line){				//check if the file is empty. 
			echo "Empty file";
			return false;
		}
		$line = strtolower(preg_replace("[^A-Za-z0-9.]", "", $line));
		$signature = mysql_entities_fix_string($conn, $line);
		echo "Malware name: ".$file.". Signature: ".$line."<br>";
		if(strlen($signature) != 20) die("Not a signature");

		store_signature($conn, $signature, $file);

		fclose($fh);
}

function store_signature($conn, $signature, $name)
{
	$stmt = $conn->prepare('INSERT INTO `signatures` (`signature`, `name`) VALUES (?, ?)');
	$stmt->bind_param('ss', $signature, $name);
	$stmt->execute();
	$stmt->close();
}




 ?>