<?php 

function mysql_entities_fix_string($connection, $string)
{
	return htmlentities(mysql_fix_string($connection, $string));
}

function mysql_fix_string($connection, $string)
{
	if (get_magic_quotes_gpc()) $string = stripslashes($string);
	return $connection->real_escape_string($string);
}

function get_hashed_string($pw, $salt1, $salt2)
{
	$token = hash('ripemd128', "$salt1$pw$salt2");
	return $token;
}

function get_random_string($length)
{
	$randomString = "";
	$characters = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
	$charLength = strlen($characters);
	for($i = 0; $i < $length; $i++)
	{
		$randomString .= $characters[rand(0, $charLength-1)];
	}
	return $randomString;
}

function validate_forename($forename)
{
	if($forename == "")
		return "No forename was entered.<br>";
	return "";
}

function validate_surname($surname)
{
	if($surname == "")
		return "No suranme was entered.<br>";
	return "";
}

function validate_username($email)
{
	if($email == "")
	{
		return "No email was entered.<br>";
	}
	elseif(!preg_match("/^[\w]+([\.-]?[\w]+)*@[\w]+([\.-]?[\w]+)*(\.\w{2,3})+$/", $email))
	{
		return "The Email address is invalid.<br>";
	}
	return "";
}

function validate_password($password)
{
	if($password == "")
	{
		return "No password was entered.<br>";
	}
	elseif(strlen($password) < 6)
	{
		return "Passwords must be at least 6 chracters.<br>";
	}
	elseif(strlen($password) < 10)
	{
		if(!preg_match("/[a-z]/", $password) || !preg_match("/[A-Z]/", $password) || !preg_match("/[0-9]/", $password))
		{
			return "Passwords less than 10 characters must have one each of a-z, A-Z and 0-9.<br>";
		}
	}
	elseif(strlen($password) < 14)
	{
		if(!preg_match("/[a-z]/", $password) || !preg_match("/[0-9]/", $password))
		{
			return "Passwords less than 14 characters must have one each of a-z and 0-9.<br>";
		}
	}
	return "";
}

function authenticate($auth, $un, $pw, $connection)
{
	$un_temp = mysql_entities_fix_string($connection, $un);
	$pw_temp = mysql_entities_fix_string($connection, $pw);
	$salt1 = $salt2 = "";


	$query = "SELECT * FROM $auth WHERE username='$un_temp'";
	$result = $connection->query($query);

	if(!$result)die($connection->error);
	elseif($result->num_rows)
	{
		$row = $result->fetch_array(MYSQLI_NUM);
		$result->close();
		$salt1 = $row[5];
		$salt2 = $row[6];
		$token = get_hashed_string($pw_temp, $salt1, $salt2);

		if ($token == $row[2]) 
		{
			session_start();
			$_SESSION[$auth] = $un_temp;
			$_SESSION['password'] = $pw_temp;
			$_SESSION['forename'] = $row[3];
			$_SESSION['surname'] = $row[4];
			setcookie($auth, $_SESSION['forename']." ".$_SESSION['surname'], time() + 60 * 60 * 24 * 7, '/');
		}
		else 
		{
			die ("Invalid username/password");
		}
	}
	else
	{
		die ("Invalid username/password");
	}
}



 ?>